import yaml
import os
import os.path
from yaml.loader import SafeLoader

if __name__ == "__main__":
    with open(os.path.join('config','settings.yaml')) as f:
        settings = yaml.load(f, Loader=SafeLoader)

    with open(os.path.join('config','tests.yaml')) as f:
        tests_config = yaml.load(f, Loader=SafeLoader)

    tests = settings["tests"]
    if tests == "all":
        tests = []
        for key, config in tests_config.items():
            for loader in config["payload"]["available_loaders"]:
                tests.append({'payload': {'name': key, 'loader': loader}})

    prev_test = None
    if os.path.exists(os.path.join('config','nexttest.yaml')):
        with open(os.path.join('config','nexttest.yaml')) as f:
            prev_test = yaml.load(f, Loader=SafeLoader)


    next_test = None
    found = False
    if prev_test:
        for test in tests:
            if found:
                next_test = test
                break
            if test == prev_test["tests"][0]:
                found = True
    else:
        next_test = tests[0]

    if next_test:
        print("----------------------------------------------------------")
        print(yaml.dump(next_test, default_flow_style=False))
        print("----------------------------------------------------------")
        settings["tests"] = [next_test]
        with open(os.path.join('config','nexttest.yaml'), 'w') as outfile:
            yaml.dump(settings, outfile, default_flow_style=False)    
    else:
        if os.path.exists(os.path.join('config','nexttest.yaml')):
            os.remove(os.path.join('config','nexttest.yaml'))
